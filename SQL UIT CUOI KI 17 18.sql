CREATE DATABASE KT1

SET DATEFORMAT DMY

CREATE TABLE KHACHHANG
(
	MAKH CHAR(4) PRIMARY KEY,
	TENKH VARCHAR(30),
	DIACHI VARCHAR(30),
	LOAIKH VARCHAR(30)
)

CREATE TABLE LOAICAY
(
	MALC CHAR(4) PRIMARY KEY,
	TENLC VARCHAR(30),
	XUATXU VARCHAR(30),
	GIA INT
)

CREATE TABLE HOADON
(	
	SOHD CHAR(5) PRIMARY KEY,
	NGHD SMALLDATETIME,
	MAKH CHAR(4),
	KHUYENMAI INT
)

CREATE TABLE CTHD
(
	SOHD CHAR(5),
	MALC CHAR(4),
	SOLUONG INT,
	CONSTRAINT PK_CTHD PRIMARY KEY(SOHD,MALC)
)


INSERT INTO KHACHHANG VALUES ('KH01','Liz Kim Cuong', 'Ha Noi','Vang lai')
INSERT INTO KHACHHANG VALUES ('KH02','Ivone Dieu Linh', 'Da Nang','Thuong xuyen')
INSERT INTO KHACHHANG VALUES ('KH03','Emma Nhat Khanh', 'TP.HCM','Vang lai')

INSERT INTO LOAICAY VALUES ('LC01','Xuong rong tai tho', 'Mexico',180000)
INSERT INTO LOAICAY VALUES ('LC02','Sen thach ngoc', 'Anh',300000)
INSERT INTO LOAICAY VALUES ('LC03','Ba mau rau', 'Nam Phi',270000)

INSERT INTO HOADON VALUES ('00001','22/11/2017', 'KH01',5)
INSERT INTO HOADON VALUES ('00002','04/12/2017', 'KH03',5)
INSERT INTO HOADON VALUES ('00003','10/12/2017', 'KH02',10)

INSERT INTO CTHD VALUES ('00001','LC01', 1)
INSERT INTO CTHD VALUES ('00001','LC02', 2)
INSERT INTO CTHD VALUES ('00001','LC03', 5)
INSERT INTO CTHD VALUES ('00003','LC03', 5)
ALTER TABLE CTHD ADD CONSTRAINT FK_CTHD FOREIGN KEY(SOHD) REFERENCES HOADON(SOHD)
ALTER TABLE CTHD ADD CONSTRAINT FK_CTHD2 FOREIGN KEY(MALC) REFERENCES LOAICAY(MALC)
DROP TABLE CTHD

ALTER TABLE LOAICAY
ADD CONSTRAINT CAU3 CHECK ((LOAICAY.GIA>250000 AND LOAICAY.XUATXU ='Anh') OR (XUATXU <> 'Anh'))

SELECT *
FROM HOADON
WHERE MONTH(NGHD) >= 10 AND MONTH(NGHD) < =12 AND YEAR(NGHD) =2017
ORDER BY KHUYENMAI ASC

SELECT MALC, TENLC, XUATXU
FROM(
	SELECT DISTINCT LOAICAY.MALC, TENLC, LOAICAY.XUATXU, SUM(SOLUONG) SL, DENSE_RANK() OVER(ORDER BY SUM(SOLUONG)) AS RANK
	FROM LOAICAY INNER JOIN CTHD ON CTHD.MALC = LOAICAY.MALC 
	INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
	WHERE MONTH(NGHD) = 12
	GROUP BY LOAICAY.MALC, TENLC, LOAICAY.XUATXU) AS G
WHERE G.RANK = 1

SELECT KHACHHANG.MAKH, MALC, KHACHHANG.LOAIKH
FROM HOADON 
JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
JOIN KHACHHANG ON KHACHHANG.MAKH = HOADON.MAKH 
WHERE LOAIKH = 'Vang lai'
	
INTERSECT
 (	
	SELECT KHACHHANG.MAKH, MALC, KHACHHANG.LOAIKH
	FROM (HOADON JOIN CTHD ON HOADON.SOHD = CTHD.SOHD) 
	JOIN KHACHHANG ON KHACHHANG.MAKH = HOADON.MAKH 
	WHERE LOAIKH = 'Thuong xuyen')

SELECT G.MAKH 
FROM (
	SELECT MAKH, COUNT(*) AS SLLC
	FROM HOADON 
	JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
	GROUP BY MAKH
	) AS G
WHERE G.SLLC = ( SELECT COUNT(*) FROM LOAICAY)

